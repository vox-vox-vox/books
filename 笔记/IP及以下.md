# TCP/IP 协议栈



TCP/IP协议栈

![image-20211111162233751](https://tva1.sinaimg.cn/large/008i3skNgy1gwbackazzsj30fu08q0t4.jpg)

传输层，网络层，链路层的通信由内核提供；应用层由用户提供。



# 链路层

## 以太网

每个以太网适配器都有一个全球唯一的48位地址，称为硬件地址。

- 通用以太网帧

![image-20211112155531383](https://tva1.sinaimg.cn/large/008i3skNgy1gwcf6qoz7bj30na03ajrg.jpg)

​		上图是通用以太网帧，源地址和目的地址就是硬件地址，共48位(6x8)。

- 装填IP数据报

  ![image-20211112155940913](https://tva1.sinaimg.cn/large/008i3skNgy1gwcfb2g5qhj30gq022q2t.jpg)

- 装填ARP协议报

  ![image-20211112155955691](https://tva1.sinaimg.cn/large/008i3skNgy1gwcfbba5ogj307j0220sk.jpg)

## ARP

### 背景

1. IP地址和硬件地址不存在映射关系，无法直接从IP得到硬件地址 
1. 硬件地址可能随时变化，如更换网络适配器 
1. 请求帧一定要知道目的地的硬件地址才能递达，而网络传输只有IP地址，所以要转换。

### 定义

ARP读取IP地址，解析成对应的硬件地址

### ARP缓存表

**每台主机**维护一个ARP缓存表，key=IP地址，value=硬件地址。里面有本局域网的其他主机和路由器的信息

ARP缓存表的生成方式：

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwbhslxlo0j31fa0fa75y.jpg" alt="image-20211111204008060" style="zoom:45%;" />

**同一个局域网内**，主机A希望向主机B发送信息，首先要得到B的硬件地址。A通过**广播**，向所有局域网的机器发送ARP数据报，里面主要表达：“我是A，我的IP是1.2.3.4，我的硬件地址是A-B-C-D，我想知道IP为5.6.7.8的机器的硬件地址”。其余机器收到后，分别检查自己的IP，符合条件B的就通过返回给A一个ARP响应(ARP响应不是广播)，里面装了自己的硬件地址。在此之后，A向B发请求就可以直接走缓存。与此同时，所有收到了A的ARP请求的机器都将A的IP和MAC存储在及自己的ARP缓存表里。最终的效果是，一次ARP广播通信后，A将B的硬件地址写入缓存，其余主机将A的硬件地址写入缓存。

**不在同一个局域网内**，主机A希望向主机E发送信息，实际上它的目的IP不是E的IP地址，而是router的IP，这是IP协议决定的，所以A要得到的是router的硬件地址。得到router硬件地址的过程和上文相同，也是通过广播。

另外，**缓存必须设置过期时间**

### Q&A

Q ARP是在发送时候解析的还是在接受时候解析的？存在一个专门的机器来进行解析吗？

A 发送的时候根据IP地址解析目的地的硬件地址，放入以太网帧中。不需要专门机器来解析。

Q 直接用硬件地址进行通信不需要ARP，为什么不直接使用硬件地址通信呢，而是使用IP地址呢？

A 全世界存在各式各样的网络，他们的硬件地址格式都不同，如果只用硬件地址通信要经过很复杂的硬件地址转换，IP地址完成了统一。

# 网络层

## IP地址

### IP地址+子网掩码

过去提出过一种A/B/C/D/E类IP地址的方法，现已废弃

目前采用CIDR(Classless Interdomain Routing)的方式，本质上为：**IP地址+子网掩码**

**IP地址=网络号+主机号**，一共32位

网络号相同的主机在一个子网里，可以相互通信

不同子网需要通过路由器连接

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwbikb4wv2j30kw051dgi.jpg" alt="image-20211111210648267" style="zoom:50%;" />

### 特殊IP地址

#### 私有地址

RFC1918 定义了一些私有地址，**这些地址不会出现在Internet上**：

10.* 

172.16.* ~ 172.31.*

192.168.*

使用私有地址的局域网主机虽然没有Internet的IP地址，但是可以通过代理服务器或NAT等技术连入Internet

#### loopback

127.* 的IP地址用于本机环回(loop back)测试，通常是127.0.0.1，下图为包含loopback的网络示意图

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwc407pax8j30n50j4ta3.jpg" alt="image-20211112092839734" style="zoom:80%;" />

#### 其他特殊IP

还有一些不能用作主机IP地址的特殊地址：

1. 目的地址为255.255.255.255 表示本网络内部广播，路由器不转发
2. 目的地址主机号全为1表示广播至某网络的所有主机。如192.168.10.255/24
3. 主机号全为0的地址只表示某网络，不表示某主机。如192.168.10.0/24

## 路由

### 路由相关概念

- 路由节点：一个具有路由能力的 **主机** 或 **路由器** ，它维护一张路由表，通过查询路由表决定向哪个接口发送数据包

- 接口：路由节点与某个网络相连的网卡接口，每个接口都有一个IP地址

- 路由表： 

  | 目的网络号                                           | 子网掩码                   | 下一跳IP地址   |
  | ---------------------------------------------------- | -------------------------- | -------------- |
  | 注意不是IP地址，而是网络地址（IP地址=网络号+主机号） | 目的网络地址对应的子网掩码 | 下一跳的IP地址 |

​		注意：主机/路由器都有路由表，但是下一跳IP对应的是路由器，因为主机可以直接通过IP地址在子网发送，不需要继续路由转发

- 默认路由：当目的IP地址与子网掩码经过与运算后，和路由表均不匹配时，就发送到默认路由的IP

### 路由转发算法

说明路由转发算法之前，首先做几个假设

- 路由表已经建立好了，而且是可靠的
- 无论主机还是路由器，在路由转发时均视为存储着路由表的路由节点

**路由转发算法**：

1. 首先要有一个**目的IP地址**

2. 将**目的IP地址**同子网掩码与运算，观察其是否与**目的网络地址**匹配

3. 若匹配，则由ARP得到下一跳IP地址对应的硬件地址，并发送到对应的路由节点上

**具体讨论**：上面将主机和路由器都视为路由节点，简化了路由转发算法的逻辑。现具体讨论如下

1. 主机-->子网内主机

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwceno914nj31s80dmq52.jpg" alt="image-20211112153711606" style="zoom:30%;" />

​		最简单的情况，直接转发即可

2. 主机-->子网内路由器

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwcepclpudj31rs0cedhs.jpg" alt="image-20211112153848664" style="zoom:30%;" />

​		出现在向广域网发数据包时，目的IP不在子网内，一般走默认路由，转发到路由器

3. 路由器-->子网内主机

   <img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwcet6trlmj31r60bamyx.jpg" alt="image-20211112154229953" style="zoom:30%;" />

   出现在传输的最后，经过了许多跳路由后终于即将到达目的主机

4. 路由器-->子网内路由器

​									<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwcevoao06j31ry0c8wgj.jpg" alt="image-20211112154452943" style="zoom:30%;" />

​		出现在传输途中				

### 路由生成算法

暂略

### Q&A

Q 为什么路由器有两个接口，这不是说明有两个IP地址？一个不行吗

# 查看mac网络相关信息

`networksetup -listallhardwareports` 查看所有接口

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwc7n8k0umj30by0f4t9h.jpg" alt="image-20211112113435587" style="zoom:80%;" />

